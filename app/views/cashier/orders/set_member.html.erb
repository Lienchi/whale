<div class="container">
  <%= render :partial => "shared/tabs1", :locals => { :selected_item => '訂單資訊' } %>
      
  <br>
  <h2>訂單列表</h2>
  <table class="table">
    <thead>
      <tr>
        <th>編號</th>
        <th>結帳人員</th>
        <th>顧客編號</th>
        <th>付款方式</th>
        <th>總金額</th>

      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="order-id"><%= @order.id%></td>
        <td><%= @order.user.name%></td>
        <td>
          <% if @order.member_id == -1%>
            非會員
          <% else%>
            <%= @order.member_id%>
          <% end%>
        </td>
        <td><%= @order.payment_method%></td>
        <td><%= @order.amount%></td>
      </tr>
      
    </tbody>
  </table>

  <form id="search-form">
    <div class="input-group col-xs-3">
      <input type="text" id="phone2" class="form-control" placeholder="請輸入手機號碼或 email">
      <div class="input-group-btn">
        <button class="btn btn-default" type="submit" id="search-btn" >
          <i class="glyphicon glyphicon-search"></i>
        </button>
      </div>
    </div>
  </form> 
  <br>
  <table class="table">
    <tbody id="search-list">
      
      <tr>
        <th>姓名</th>
        <th>手機號碼</th>
        <th>性別</th>
        <th>信箱</th>
        <th>生日</th>
        <th>功能</th>
      </tr>     
        
    </tbody>
  </table>  


</div>

<script type="text/javascript">
  $("#search-btn").click(function(){
    
    event.preventDefault();
    $(".search-item").remove();//刪除原先的搜尋結果
    
    var search_word = $("#phone2").val();
    if(search_word.length < 3)//至少要輸入3碼才能搜尋
    {
      //alert(phone2);
      //alert(phone2.length);
      alert("錯誤!輸入長度不足3碼");
    }else{
      $.ajax({
        url: "/cashier/members/search_outcome" ,
        method: "POST",
        dataType: "json",
        data: {
          phone: search_word,
        },
        success: function(datas){
          if(datas.length == 0){
            alert("No data found");
          }
          else{
            for( var i = 0 ; i < datas.length ; i++ ){
              var member = document.createElement("tr");
              var data = datas[i];
              var order_id = $(".order-id").html();

              member.id = data["id"];
              $(member).attr("class","search-item");
              $(member).html($("#member-template").html());
              $(member).find(".name").html(data["name"]);
              $(member).find(".phone").html(data["phone"]);
              $(member).find(".gender").html(data["gender"]);
              $(member).find(".email").html(data["email"]);
              if(data["birthday"].substring(5, 7) == new Date().getMonth()+1){
                $(member).find(".birthday").append(data["birthday"] + " <i class=\"fa fa-birthday-cake\" aria-hidden=\"true\" style=\"color:#FF9900\"></i>");
              }
              else{
                $(member).find(".birthday").html(data["birthday"]);
              }
            
              var url = document.createElement("a");
              url.href = "/cashier/orders/"+order_id+"/edit?member_id=" +member.id;
              $(url).html("綁定");
              $(member).find(".setmember").html(url);
          
              $("#search-list").append(member);
              console.log(data["name"]);
            }
          }
        }
      });
    }
  });
</script>

<script type="text/template" id="member-template">
  
  <td class="name"></td>
  <td class="phone"></td>
  <td class="gender"></td>
  <td class="email"></td>
  <td class="birthday"></td>
  <td ><button class="setmember"></button></td>
</script>